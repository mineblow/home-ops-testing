---
  name: üèóÔ∏è Monthly Proxmox Template Builder
  
  on:
    schedule:
      - cron: '0 5 1 * *'
    workflow_dispatch:
  
  jobs:
    detect-templates:
      runs-on: ubuntu-latest
      timeout-minutes: 30
      
      outputs:
        templates: ${{ steps.set.outputs.templates }}
      steps:
        - name: üìé Checkout repo
          uses: actions/checkout@v4
  
        - id: set
          run: |
            files=$(find .scripts/cicd/templates -type f -name '*-template.sh' -exec basename {} \;)
            echo "Found templates: $files"
            json=$(jq -nc --argjson arr "$(printf '%s\n' $files | jq -R . | jq -s .)" '$arr')
            echo "templates=$json" >> "$GITHUB_OUTPUT"
  
    build-template:
      needs: detect-templates
      runs-on: ubuntu-latest
      timeout-minutes: 30
  
      permissions:
        contents: write
        pull-requests: write
        id-token: write

      strategy:
        matrix:
          template: ${{ fromJson(needs.detect-templates.outputs.templates) }}
  
      steps:
        - name: üìé Checkout repo
          uses: actions/checkout@v4
  
        - name: üîê Authenticate to Google Cloud
          uses: google-github-actions/auth@v1
          with:
            credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}
  
        - name: üß† Extract Vault bootstrap from GCP
          run: bash ./.scripts/cicd/bootstrap/auth-google.sh
  
        - name: üåê Start Tailscale (GitHub-hosted)
          uses: tailscale/github-action@v2
          with:
            oauth-client-id: ${{ env.TAILSCALE_CLIENT_ID }}
            oauth-secret: ${{ env.TAILSCALE_CLIENT_SECRET }}
            hostname: template-builder-ci
            tags: tag:github-ci
  
        - name: üí† Install Vault CLI
          run: bash .scripts/cicd/bootstrap/install-vault.sh
  
        - name: üîì Authenticate to Vault
          env:
            VAULT_ROLE: template-builder-ci
          run: bash ./.scripts/cicd/bootstrap/vault-auth.sh

        - name: üîê Fetch Proxmox secrets from Vault
          run: |
            set -euo pipefail
  
            SECRET_PATH="kv/home-ops/environment/homelab/template-builder/secrets/proxmox_ssh_key_private"
            echo "üîë Fetching SSH key from Vault: $SECRET_PATH"
            
            vault kv get -field=value "$SECRET_PATH" | cat > proxmox.key
        
            # echo ""
            # echo "üîê Masking key contents line by line..."
            # while IFS= read -r line; do
            #   echo "::add-mask::$line"
            # done < proxmox.key
        
            echo ""
            echo "üîß Setting permissions on key file"
            chmod 600 proxmox.key

            echo "üîë Fetching SSH user + domain"
            PROXMOX_SSH_USER=$(vault kv get -field=value kv/home-ops/global/proxmox/proxmox_ssh_user)
            PROXMOX_DOMAIN=$(vault kv get -field=value kv/home-ops/global/proxmox/domain)
            echo "::add-mask::$PROXMOX_SSH_USER"
            echo "::add-mask::$PROXMOX_DOMAIN"
            echo "PROXMOX_SSH_USER=$PROXMOX_SSH_USER" >> "$GITHUB_ENV"
            echo "PROXMOX_DOMAIN=$PROXMOX_DOMAIN" >> "$GITHUB_ENV"
          env:
            VAULT_ADDR: ${{ env.VAULT_ADDR }}
            VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
  
        - name: üì§ Copy script to Proxmox host
          run: |
            ssh -o StrictHostKeyChecking=no -i proxmox.key \
              "$PROXMOX_SSH_USER@$PROXMOX_DOMAIN" \
              "mkdir -p /home/$PROXMOX_SSH_USER/scripts"
          
            scp -i proxmox.key -o StrictHostKeyChecking=no \
              ".scripts/cicd/templates/${{ matrix.template }}" \
              $PROXMOX_SSH_USER@$PROXMOX_DOMAIN:/home/$PROXMOX_SSH_USER/scripts/
  
            ssh -i proxmox.key -o StrictHostKeyChecking=no \
              $PROXMOX_SSH_USER@$PROXMOX_DOMAIN \
              "sudo -n chmod +x /home/$PROXMOX_SSH_USER/scripts/${{ matrix.template }}"
  
        - name: üöÄ Execute and delete script on Proxmox host
          run: |
            set -euo pipefail
            SCRIPT_NAME=${{ matrix.template }}
  
            echo "üöÄ Running $SCRIPT_NAME remotely on $PROXMOX_DOMAIN"
            ssh -i proxmox.key -o StrictHostKeyChecking=no "$PROXMOX_SSH_USER@$PROXMOX_DOMAIN" \
              "bash -c 'set -euo pipefail && sudo -n /home/$PROXMOX_SSH_USER/scripts/$SCRIPT_NAME && rm -f /home/$PROXMOX_SSH_USER/scripts/$SCRIPT_NAME'"

        - name: üì• Pull metadata from Proxmox
          id: fetch_meta
          run: |
            SCRIPT_NAME="${{ matrix.template }}"
            META_NAME="${SCRIPT_NAME/.sh/.meta.json}"
        
            echo "üì• Downloading $META_NAME from Proxmox..."
            scp -i proxmox.key -o StrictHostKeyChecking=no \
              "$PROXMOX_SSH_USER@$PROXMOX_DOMAIN:/var/lib/vz/template/$META_NAME" \
              "./$META_NAME"
        
            if [[ ! -s "$META_NAME" ]]; then
              echo "‚ùå Failed to fetch metadata file or file is empty"
              exit 1
            fi
        
            echo "‚úÖ Pulled and verified: $META_NAME"
        
            echo "meta_file=$META_NAME" >> "$GITHUB_OUTPUT"
        
            echo "üßπ Cleaning up metadata from remote"
            ssh -i proxmox.key -o StrictHostKeyChecking=no \
              "$PROXMOX_SSH_USER@$PROXMOX_DOMAIN" \
              "rm -f /var/lib/vz/template/$META_NAME"
            
        - name: üîê Push metadata to Vault
          run: |
            META_FILE="${{ steps.fetch_meta.outputs.meta_file }}"
            TEMPLATE_ID=$(jq -r '.template_name' "$META_FILE" | cut -d'-' -f1-2)
            VAULT_PATH="kv/home-ops/environment/homelab/template-builder/build-state/${TEMPLATE_ID}"
        
            echo "üì¶ Pushing $META_FILE to Vault at $VAULT_PATH"
            vault kv put "$VAULT_PATH" @"$META_FILE"
          env:
            VAULT_ADDR: ${{ env.VAULT_ADDR }}
            VAULT_TOKEN: ${{ env.VAULT_TOKEN }}
                            
        - name: üßπ Cleanup
          if: always()
          run: rm -f proxmox.key vault.json *.meta.json
        
  