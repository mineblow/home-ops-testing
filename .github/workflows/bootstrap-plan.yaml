name: 🚀 Terraform Plan (bootstrap-runner)

on:
  repository_dispatch:
    types: [terraform-bootstrap-runner]
  workflow_dispatch:

jobs:
  bootstrap-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write
      id-token: write

    env:
      ENV_NAME: bootstrap-runner
      ENV_PATH: terraform/environments/homelab/bootstrap-runner
      RUNNER_ENV: github-ci

    steps:
      - name: 🥦 Checkout repo
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}

      - name: 🧠 Extract Vault bootstrap from GCP
        run: bash ./.scripts/cicd/bootstrap/auth-google.sh

      - name: 🌐 Start Tailscale
        if: ${{ env.RUNNER_ENV != 'self-hosted' }}
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ env.TAILSCALE_CLIENT_ID }}
          oauth-secret: ${{ env.TAILSCALE_CLIENT_SECRET }}
          hostname: github-bootstrap-plan
          tags: tag:github-ci

      - name: 🌐 Start Tailscale (self-hosted)
        if: ${{ env.RUNNER_ENV == 'self-hosted' }}
        run: bash ./.scripts/cicd/bootstrap/start-tailscale.sh

      - name: 🔓 Authenticate to Vault (read)
        env:
          VAULT_ROLE: bootstrap-runner-read
          VAULT_TOKEN_VAR_NAME: VAULT_TOKEN_READ
        run: bash ./.scripts/cicd/bootstrap/vault-auth.sh

      - name: 🔑 Authenticate to Vault (write)
        env:
          VAULT_ROLE: bootstrap-runner-rw
          VAULT_TOKEN_VAR_NAME: VAULT_TOKEN_RW
        run: bash ./.scripts/cicd/bootstrap/vault-auth.sh

      - name: 🔐 Fetch secrets & write tfvars files
        run: |
          set -euo pipefail
          mkdir -p "$ENV_PATH"
          > "$ENV_PATH/vault.auto.tfvars"
          > "$ENV_PATH/backend-consul.hcl"
          > "$ENV_PATH/terraform.auto.tfvars"

          VAULT_PREFIX="kv/data/home-ops/environment/homelab/$ENV_NAME/secrets"

          for SECRET in proxmox_api_url proxmox_api_token proxmox_user proxmox_ssh_key consul_state_locking_token consul_state_locking_path; do
            VAL=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN_READ" "$VAULT_ADDR/v1/${VAULT_PREFIX}/$SECRET" | jq -r '.data.data.value // empty')

            if [ -z "$VAL" ]; then
              echo "::warning::Vault key $SECRET returned empty or not found"
            fi

            case $SECRET in
              proxmox_user)
                [ -n "$VAL" ] && echo "::add-mask::$VAL"
                printf "proxmox_ssh_user = \"%s\"\n" "$VAL" >> "$ENV_PATH/vault.auto.tfvars"
                ;;
              proxmox_ssh_key)
                if [ -n "$VAL" ]; then
                  echo "$VAL" | while IFS= read -r line; do
                    [ -n "$line" ] && echo "::add-mask::$line"
                  done
                else
                  echo "::warning::$SECRET (SSH key) is empty, skipping mask"
                fi
                echo "$VAL" > "$ENV_PATH/proxmox.key" 2>/dev/null
                chmod 600 "$ENV_PATH/proxmox.key"
                printf "proxmox_ssh_private_key = \"proxmox.key\"\n" >> "$ENV_PATH/vault.auto.tfvars"
                ;;
              proxmox_api_url|proxmox_api_token)
                [ -n "$VAL" ] && echo "::add-mask::$VAL"
                printf "%s = \"%s\"\n" "$SECRET" "$VAL" >> "$ENV_PATH/vault.auto.tfvars"
                ;;
              consul_state_locking_token)
                [ -n "$VAL" ] && echo "::add-mask::$VAL"
                echo "CONSUL_HTTP_TOKEN=$VAL" >> $GITHUB_ENV
                ;;
              consul_state_locking_path)
                printf "path = \"%s\"\n" "$VAL" >> "$ENV_PATH/backend-consul.hcl"
                ;;
            esac
          done

          CONSUL_DOMAIN=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN_READ" "$VAULT_ADDR/v1/kv/data/home-ops/consul/domain" | jq -r '.data.data.value // empty' | sed 's:/*$::')
          printf "address = \"%s\"\n" "$CONSUL_DOMAIN" >> "$ENV_PATH/backend-consul.hcl"
          echo "CONSUL_HTTP_ADDR=$CONSUL_DOMAIN" >> $GITHUB_ENV

          VM_CONFIG=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN_READ" "$VAULT_ADDR/v1/kv/data/home-ops/environment/homelab/$ENV_NAME/opentofu/terraform-auto-tfvars" | jq -r '.data.data.value // empty')
          echo "$VM_CONFIG" | while IFS= read -r line; do echo "::add-mask::$line"; done
          printf "%s\n" "$VM_CONFIG" >> "$ENV_PATH/terraform.auto.tfvars"

      - name: 📅 Install OpenTofu
        run: |
          curl -fsSL https://get.opentofu.org/install-opentofu.sh -o install-opentofu.sh
          chmod +x install-opentofu.sh
          ./install-opentofu.sh --install-method standalone --opentofu-version 1.6.2
          echo "$HOME/.opentofu/bin" >> $GITHUB_PATH
          echo "PATH=$HOME/.opentofu/bin:$PATH" >> $GITHUB_ENV

      - name: 📦 Tofu Init
        working-directory: ${{ env.ENV_PATH }}
        run: tofu init -backend-config=backend-consul.hcl -reconfigure

      - name: 🦢 Tofu Plan (silent)
        working-directory: ${{ env.ENV_PATH }}
        run: tofu plan -no-color -out=tfplan

      - name: 🗃 Save tfplan to Vault
        run: |
          PLAN_PATH="${ENV_PATH}/tfplan"
          [ ! -f "$PLAN_PATH" ] && echo "tfplan not found" && exit 1

          PLAN_B64=$(base64 < "$PLAN_PATH" | tr -d '\n')
          echo "$PLAN_B64" | fold -w 64 | while read line; do echo "::add-mask::$line"; done

          curl -s --request POST "$VAULT_ADDR/v1/kv/data/home-ops/environment/homelab/${ENV_NAME}/opentofu/plans/staging" \
            --header "X-Vault-Token: $VAULT_TOKEN_RW" \
            --header "Content-Type: application/json" \
            --data "$(printf '{\"data\":{\"plan\":\"%s\"}}' "$PLAN_B64")"

      - name: 🚓 Create or update Terraform Plan PR
        run: |
          BRANCH="plan-$ENV_NAME"
          FILE=".plan-$ENV_NAME"
          COMMIT_MSG="🚓 Plan for $ENV_NAME"
          PLAN_PATH="kv/home-ops/environment/homelab/$ENV_NAME/opentofu/plans/staging"
          TIMESTAMP="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          git config --global user.email "opentofu-bot@mineblow.me"
          git config --global user.name "OpenTofu CI Bot"

          git fetch origin

          VERSION=$(curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN_READ" \
            "$VAULT_ADDR/v1/kv/metadata/home-ops/environment/homelab/$ENV_NAME/opentofu/plans/staging" \
            | jq -r '.data.current_version // "unknown"')

          BODY=$(printf '%s\n' \
            "### 🚓 Terraform Plan for \\`$ENV_NAME\\`" \
            "" \
            "📆 **Stored securely in Vault:**" \
            "\\`$PLAN_PATH\\` (version: \\`$VERSION\\`)" \
            "" \
            "📌 To view:" \
            '```bash' \
            "vault kv get -field=plan -version=$VERSION $PLAN_PATH | base64 -d | less" \
            '```' \
            "" \
            "✅ Merge this PR to trigger apply." \
            "" \
            "🕓 Generated: \\`$TIMESTAMP\\`")

          if git ls-remote --exit-code --heads origin "$BRANCH" &>/dev/null; then
            echo "🔄 Branch exists, updating..."
            git checkout "$BRANCH"
            echo "$PLAN_PATH - Generated at $TIMESTAMP (version $VERSION)" > "$FILE"
            git add "$FILE"
            git commit -m "$COMMIT_MSG" || echo "ℹ️ Nothing to commit"
            git push origin "$BRANCH" || echo "ℹ️ Nothing to push"
            echo "✍️ Updating PR body..."
            gh pr edit "$BRANCH" --body "$BODY"
          else
            echo "🚀 Creating new branch and PR..."
            git checkout -b "$BRANCH"
            echo "$PLAN_PATH - Generated at $TIMESTAMP (version $VERSION)" > "$FILE"
            git add "$FILE"
            git commit -m "$COMMIT_MSG"
            git push origin "$BRANCH"
            gh pr create --title "$COMMIT_MSG" --body "$BODY"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VAULT_TOKEN_READ: ${{ env.VAULT_TOKEN_READ }}
          VAULT_TOKEN_RW: ${{ env.VAULT_TOKEN_RW }}
          VAULT_ADDR: ${{ env.VAULT_ADDR }}

      - name: 🪩 Cleanup
        if: always()
        run: |
          rm -f vault.json vault.auto.tfvars terraform.auto.tfvars backend-consul.hcl tfplan install-opentofu.sh ${{ env.ENV_PATH }}/proxmox.key || true
