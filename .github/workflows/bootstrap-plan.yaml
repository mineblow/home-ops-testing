name: ðŸš€ Terraform Plan (bootstrap-runner)

on:
  repository_dispatch:
    types: [terraform-bootstrap-runner]
  workflow_dispatch:

jobs:
  bootstrap-plan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      pull-requests: write
      id-token: write

    env:
      ENV_NAME: bootstrap-runner
      ENV_PATH: terraform/environments/homelab/bootstrap-runner

    steps:
      - name: ðŸ¥¦ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_JSON }}

      - name: ðŸ§  Extract Vault bootstrap from GCP
        run: bash ./.scripts/cicd/bootstrap/auth-google.sh

      - name: ðŸŒ Start Tailscale
        run: bash ./.scripts/cicd/bootstrap/start-tailscale.sh

      - name: ðŸ”“ Authenticate to Vault (home-ops)
        run: bash ./.scripts/cicd/bootstrap/vault-auth.sh

      - name: ðŸ” Fetch secrets & write tfvars files
        run: |
          set -euo pipefail
          mkdir -p "$ENV_PATH"
          > "$ENV_PATH/vault.auto.tfvars"
          > "$ENV_PATH/backend-consul.hcl"
          > "$ENV_PATH/terraform.auto.tfvars"

          # Proxmox API secrets
          declare -A PROXMOX=(
            ["proxmox_api_url"]="api_url"
            ["proxmox_api_token"]="automation_full_token"
          )

          for VAR in "${!PROXMOX[@]}"; do
            VAL=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
              "$VAULT_ADDR/v1/kv/data/home-ops/proxmox/${PROXMOX[$VAR]}" \
              | jq -r '.data.data.value // empty')
            echo "::add-mask::$VAL"
            echo "$VAR = \"$VAL\"" >> "$ENV_PATH/vault.auto.tfvars"
          done

          echo 'proxmox_ssh_user = "auto"' >> "$ENV_PATH/vault.auto.tfvars"

          # SSH Key
          SSH_KEY=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/kv/data/home-ops/proxmox/automation_ssh_key" \
            | jq -r '.data.data.value // empty')

          echo "::add-mask::$SSH_KEY"
          printf "%s" "$SSH_KEY" > "$ENV_PATH/proxmox.key"
          chmod 600 "$ENV_PATH/proxmox.key"

          echo "proxmox_ssh_private_key = \"proxmox.key\"" >> "$ENV_PATH/vault.auto.tfvars"

          # Consul Backend
          LOCK_PATH=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/kv/data/home-ops/opentofu/homelab/$ENV_NAME/consul/state_locking_path" \
            | jq -r '.data.data.value // empty')

          LOCK_TOKEN=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/kv/data/home-ops/opentofu/homelab/$ENV_NAME/consul/state_locking_token" \
            | jq -r '.data.data.value // empty')

          CONSUL_DOMAIN=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/kv/data/home-ops/consul/domain" \
            | jq -r '.data.data.value // empty' | sed 's:/*$::')

          echo "::add-mask::$LOCK_TOKEN"
          echo "address = \"$CONSUL_DOMAIN\"" >> "$ENV_PATH/backend-consul.hcl"
          echo "path    = \"$LOCK_PATH\"" >> "$ENV_PATH/backend-consul.hcl"

          echo "CONSUL_HTTP_ADDR=$CONSUL_DOMAIN" >> $GITHUB_ENV
          echo "CONSUL_HTTP_TOKEN=$LOCK_TOKEN" >> $GITHUB_ENV

          # vm_config JSON blob from Vault
          VM_CONFIG=$(curl -s -H "X-Vault-Token: $VAULT_TOKEN" \
            "$VAULT_ADDR/v1/kv/data/home-ops/opentofu/homelab/$ENV_NAME/terraform-auto-tfvars" \
            | jq -r '.data.data.value // empty')

          echo "::add-mask::$VM_CONFIG"
          echo "vm_config = $VM_CONFIG" >> "$ENV_PATH/terraform.auto.tfvars"

      - name: ðŸ“¥ Install OpenTofu
        run: |
          curl -fsSL https://get.opentofu.org/install-opentofu.sh -o install-opentofu.sh
          chmod +x install-opentofu.sh
          ./install-opentofu.sh --install-method standalone --opentofu-version 1.6.2
          echo "$HOME/.opentofu/bin" >> $GITHUB_PATH
          echo "PATH=$HOME/.opentofu/bin:$PATH" >> $GITHUB_ENV

      - name: ðŸ“¦ Tofu Init
        working-directory: ${{ env.ENV_PATH }}
        run: tofu init -backend-config=backend-consul.hcl -reconfigure

      - name: ðŸ§Š Tofu Plan
        working-directory: ${{ env.ENV_PATH }}
        run: tofu plan -no-color -out=tfplan

      - name: ðŸ”“ Re-auth as vault-writer
        env:
          VAULT_ROLE: vault-writer
        run: bash ./scripts/vault-auth.sh

      - name: ðŸ’¾ Save tfplan to Vault
        run: bash ./scripts/push-tfplan.sh

      - name: ðŸ§Š Comment plan in PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = [
              '### ðŸ§Š Terraform Plan for `bootstrap-runner`',
              '',
              'ðŸ“¦ Plan stored in Vault:',
              '`kv/home-ops/opentofu/homelab/bootstrap-runner/plans/staging`',
              '',
              'ðŸ§¾ To view it:',
              '```bash',
              'vault kv get -field=plan kv/home-ops/opentofu/homelab/bootstrap-runner/plans/staging | base64 -d | less',
              '```',
              `âœ… Commit: \`${{ github.sha }}\``,
              `ðŸ•“ Generated: \`${new Date().toISOString()}\``
            ].join('\n');

            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              state: 'open'
            });

            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                issue_number: prs.data[0].number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f vault.json vault.auto.tfvars terraform.auto.tfvars backend-consul.hcl tfplan install-opentofu.sh ${{ env.ENV_PATH }}/proxmox.key || true
